<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        discord: {
                            bg: '#313338',
                            sidebar: '#2b2d31',
                            element: '#232428', 
                            hover: '#35373c',
                            active: '#3f4147'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --primary: #5865f2;
            --link: #00b0f4;
            --mention-bg: rgba(88, 101, 242, 0.1);
            --bg-selected: rgba(128, 128, 128, 0.16);
            --deleted-color: #ed4245;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: #2b2d31; }
        ::-webkit-scrollbar-thumb { background-color: #1a1b1e; border-radius: 4px; }
        html:not(.dark) ::-webkit-scrollbar-track { background-color: #f2f3f5; }
        html:not(.dark) ::-webkit-scrollbar-thumb { background-color: #c4c9ce; }

        /* Hide Sidebar Scrollbar */
        #server-rail { overflow-x: hidden !important; scrollbar-width: none; }
        #server-rail::-webkit-scrollbar { display: none; }

        /* Server Icon */
        .server-icon {
            width: 48px; height: 48px; min-height: 48px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            background-color: #313338; color: #dbdee1;
            overflow: hidden;
            margin-bottom: 8px; /* Spacing */
        }
        html:not(.dark) .server-icon { background-color: #e3e5e8; color: #060607; }

        .server-icon:hover, .server-icon.active { border-radius: 16px; background-color: #5865f2; color: white; }
        .server-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; }
        
        .server-icon.active::before {
            content: ''; position: absolute; left: -14px; top: 10px; height: 28px; width: 8px;
            background-color: white; border-radius: 0 4px 4px 0;
            html:not(.dark) & { background-color: #060607; }
        }

        /* Folders */
        .folder-closed {
            width: 48px; height: 48px; border-radius: 24px;
            background-color: rgba(88, 101, 242, 0.25); cursor: pointer;
            display: flex; flex-wrap: wrap; padding: 10px; gap: 4px; justify-content: center; align-content: center;
        }
        .folder-closed:hover { border-radius: 16px; background-color: #5865f2; }
        .folder-icon-thumb { width: 10px; height: 10px; border-radius: 50%; object-fit: cover; }
        .server-icon.in-folder::after { content: ''; position: absolute; inset: 0; background-color: rgba(0,0,0,0.1); pointer-events: none; }

        /* Channels */
        .channel-item { border-radius: 4px; color: #949ba4; margin-bottom: 2px; }
        .channel-item:hover { background-color: var(--bg-selected); color: #dbdee1; }
        .channel-item.active { background-color: rgba(79, 84, 92, 0.48); color: white; }
        html:not(.dark) .channel-item.active { background-color: rgba(116, 127, 141, 0.2); color: #060607; }

        /* Pings */
        .ping-dot {
            position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px;
            background-color: #ed4245; border-radius: 50%; border: 3px solid #2b2d31; z-index: 20; pointer-events: none;
        }

        /* Message Group */
        .message-group { position: relative; width: 100%; margin-top: 1.0625rem; }
        .message-group.grouped { margin-top: 2px; }
        .message-group:hover { background-color: rgba(4, 4, 5, 0.07); }
        .message-toolbar { 
            opacity: 0; pointer-events: none; transform: translateY(-4px); transition: 0.1s;
            background-color: #313338; border: 1px solid #1f2023;
        }
        html:not(.dark) .message-toolbar { background-color: white; border: 1px solid #ccc; }
        .message-group:hover .message-toolbar { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .mention-highlight { background-color: rgba(250, 166, 26, 0.1); position: relative; }
        .mention-highlight::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background-color: #faa61a; }
        .mention { background: rgba(88,101,242,0.3); color:#c9cdfb; padding:0 2px; border-radius:3px; cursor:pointer; }
        .mention:hover { background: #5865f2; color:white; }

        /* Reply & Deleted */
        .reply-spine {
            position: absolute; top: 12px; left: -22px; width: 32px; height: 10px;
            border-left: 2px solid #4e5058; border-top: 2px solid #4e5058; border-top-left-radius: 6px; pointer-events: none;
        }
        .deleted-text { color: #da373c; font-size: 0.75rem; margin-left: 4px; font-weight: bold; }
        .deleted-img { filter: grayscale(100%); opacity: 0.6; transition: 0.2s; }
        .deleted-img:hover { filter: grayscale(0%); opacity: 1; }

        /* User Panel */
        #user-info-panel .avatar-wrap {
            width: 32px; height: 32px; position: relative; border-radius: 50%; overflow: hidden;
        }
        
        /* Settings Tabs */
        .settings-tab { padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 2px; color: #b5bac1; }
        .settings-tab:hover { background-color: #3f4147; color: #dbdee1; }
        .settings-tab.active { background-color: #404249; color: white; cursor: default; }
        
        .switch { position: relative; width: 40px; height: 24px; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #80848e; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3ba55c; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Animations */
        @keyframes flash-anim { 0%{background:rgba(250,166,26,0.2)} 100%{background:transparent} }
        .flash-highlight { animation: flash-anim 1s; }
    </style>
</head>
<body class="font-sans h-screen flex overflow-hidden bg-white dark:bg-[#313338] text-gray-900 dark:text-[#dbdee1]">

    <!-- Auth -->
    <div id="auth-section" class="fixed inset-0 z-[100] bg-gray-100 dark:bg-[#313338] flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white dark:bg-[#2b2d31] p-8 rounded shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-6">Discord Lite</h1>
            <div id="account-selection" class="hidden w-full space-y-4">
                <div id="saved-list" class="max-h-60 overflow-y-auto pr-1 space-y-2"></div>
                <div class="text-center">
                    <button class="text-sm text-gray-500 hover:text-blue-500" onclick="toggleAuthMode(false)">Âà•„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</button>
                </div>
            </div>
            <div id="token-form" class="w-full">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Token</label>
                <input type="password" id="token-input" class="w-full p-2.5 rounded bg-gray-200 dark:bg-[#1e1f22] mb-4 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-[#5865f2]">
                <button id="login-btn" class="w-full bg-[#5865f2] hover:bg-[#4752c4] text-white font-bold py-2.5 rounded transition-colors">„É≠„Ç∞„Ç§„É≥</button>
                <button id="back-btn" class="hidden w-full text-sm text-gray-500 mt-2 hover:underline" onclick="toggleAuthMode(true)">Êàª„Çã</button>
                <div id="login-error" class="text-red-500 text-xs mt-2 text-center h-4"></div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div id="main-app" class="hidden flex-1 flex w-full h-full">
        <!-- Sidebar -->
        <div id="sidebar-view" class="flex w-full md:w-auto h-full bg-[#e3e5e8] dark:bg-[#1e1f22] z-10 relative">
            <!-- Server Rail -->
            <div id="server-rail" class="w-[72px] flex-shrink-0 flex flex-col items-center py-3 overflow-y-auto">
                <div id="dm-icon" class="server-icon bg-[#5865f2] active hover:bg-[#5865f2]" onclick="loadDMs()">
                     <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
                </div>
                <div class="w-8 h-[2px] bg-gray-300 dark:bg-[#35363c] rounded mb-2"></div>
                <div id="guild-list" class="w-full flex flex-col items-center gap-1"></div>
            </div>

            <!-- Channel Panel -->
            <div class="w-full md:w-60 flex flex-col bg-[#f2f3f5] dark:bg-[#2b2d31] rounded-tl-lg h-full border-l dark:border-[#1f2023] border-gray-300 md:border-none relative">
                <div class="h-12 flex-shrink-0 border-b border-gray-300 dark:border-[#1f2023] px-4 flex items-center font-bold shadow-sm cursor-pointer hover:bg-gray-200 dark:hover:bg-[#35373c] transition-colors select-none" id="guild-header">
                    Discord Lite
                </div>
                <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                
                <!-- User Panel (Restore style: contained, not overflowing) -->
                <div id="user-info-panel" class="h-[52px] bg-[#ebedef] dark:bg-[#232428] flex items-center px-2 py-1.5 gap-2 select-none relative flex-shrink-0">
                    <div class="flex items-center gap-2 flex-1 min-w-0 p-1 hover:bg-gray-300 dark:hover:bg-[#3f4147] rounded cursor-pointer" onclick="document.getElementById('account-switcher').classList.toggle('hidden')">
                        <div id="current-user-avatar" class="avatar-wrap bg-gray-500 flex-shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <div id="current-user-name" class="text-sm font-semibold truncate leading-tight"></div>
                            <div id="current-user-tag" class="text-xs opacity-60 truncate leading-tight"></div>
                        </div>
                    </div>
                    <button class="p-2 rounded hover:bg-gray-300 dark:hover:bg-[#3f4147]" onclick="openSettings()">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></path></svg>
                    </button>
                    <!-- Account Switcher Popover -->
                    <div id="account-switcher" class="hidden absolute bottom-full left-0 right-0 mb-2 mx-2 bg-white dark:bg-[#111214] rounded shadow-xl border dark:border-[#1e1f22] overflow-hidden z-50">
                        <div id="account-list" class="max-h-64 overflow-y-auto"></div>
                        <div class="border-t dark:border-gray-700 p-1 bg-gray-50 dark:bg-[#1e1f22]">
                            <div class="p-2 text-sm cursor-pointer hover:bg-blue-500 hover:text-white rounded" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà (Ë™çË®ºÁîªÈù¢„Å∏)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div id="chat-section" class="hidden flex-1 md:flex flex-col min-w-0 bg-white dark:bg-[#313338] relative">
            <div class="h-12 border-b dark:border-[#26272d] border-gray-200 flex items-center px-4 shadow-sm flex-shrink-0 justify-between bg-white dark:bg-[#313338] z-20">
                <div class="flex items-center font-bold truncate">
                    <button class="md:hidden mr-4 text-gray-500" onclick="showSidebar()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <span class="text-2xl mr-2 text-gray-400 font-light">#</span>
                    <span id="channel-title">Select Channel</span>
                </div>
            </div>
            
            <!-- Message Container: NO scroll-smooth class -->
            <div id="message-container" class="flex-1 overflow-y-auto pt-4 pb-4"></div>

            <!-- Input -->
            <div class="px-4 pb-6 pt-2 bg-white dark:bg-[#313338] z-30">
                <!-- Addons (Reply/Attach) -->
                <div id="input-addons" class="hidden flex-col gap-1 bg-[#ebedef] dark:bg-[#2b2d31] rounded-t-lg px-4 py-2 text-xs border-b border-gray-300 dark:border-gray-700">
                    <div id="reply-preview" class="hidden flex justify-between text-gray-500">
                        <span>Replying to <strong id="reply-target">User</strong></span>
                        <span class="cursor-pointer font-bold hover:text-white" onclick="cancelReply()">‚úï</span>
                    </div>
                    <div id="attach-preview" class="hidden flex justify-between text-gray-500">
                        <span id="file-name">filename.png</span>
                        <span class="cursor-pointer font-bold hover:text-white" onclick="cancelAttachment()">‚úï</span>
                    </div>
                </div>

                <div class="bg-[#ebedef] dark:bg-[#383a40] rounded-lg flex relative items-end">
                    <button class="p-3 text-gray-500 hover:text-gray-200" onclick="document.getElementById('file-input').click()">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                    </button>
                    <input type="file" id="file-input" class="hidden">
                    <textarea id="message-input" rows="1" class="flex-1 bg-transparent border-none outline-none py-3 text-black dark:text-[#dbdee1] max-h-[50vh] resize-none scrollbar-hide" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°"></textarea>
                    <button id="send-button" class="p-3 text-[#5865f2] disabled:opacity-50 cursor-pointer">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                    <div id="char-count" class="absolute bottom-1 right-2 text-[10px] text-gray-500 font-mono hidden">0/2000</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal (Restored 2-pane) -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-4xl h-[80vh] bg-white dark:bg-[#313338] flex rounded-lg shadow-2xl overflow-hidden">
            <!-- Sidebar -->
            <div class="w-1/3 max-w-[220px] bg-[#f2f3f5] dark:bg-[#2b2d31] flex flex-col pt-10 px-2 pb-4">
                <div class="px-2 mb-2 text-xs font-bold text-gray-500 uppercase">Settings</div>
                <div class="settings-tab active" onclick="switchTab('plugins')">Plugins</div>
                <div class="settings-tab" onclick="switchTab('general')">General</div>
                <div class="flex-1"></div>
                <!-- GitHub Link (Restored) -->
                <a href="https://github.com/discord-lite/discord-lite" target="_blank" class="px-3 py-2 text-xs text-gray-500 hover:text-black dark:hover:text-gray-300 flex items-center gap-1 opacity-70 hover:opacity-100">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg> GitHub
                </a>
            </div>
            <!-- Content -->
            <div class="flex-1 relative bg-white dark:bg-[#313338] flex flex-col">
                <button class="absolute top-4 right-4 text-gray-500 hover:text-black dark:hover:text-white p-2 rounded-full border-2 border-gray-500/50 hover:bg-gray-200 dark:hover:bg-gray-700" onclick="closeSettings()">‚úï</button>
                <div id="tab-content-plugins" class="p-8 overflow-y-auto h-full">
                    <h2 class="text-xl font-bold mb-4">Plugins</h2>
                    <div id="plugin-list" class="space-y-4"></div>
                </div>
                <div id="tab-content-general" class="hidden p-8 overflow-y-auto h-full">
                    <h2 class="text-xl font-bold mb-4">General</h2>
                    <div class="mb-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Theme</h3>
                        <div class="flex gap-4">
                            <div class="w-32 h-20 bg-[#2b2d31] rounded-lg cursor-pointer border-2 border-transparent hover:border-[#5865f2] relative" onclick="setTheme('dark')">
                                <span class="text-white text-xs font-bold absolute bottom-2 left-2">Dark</span>
                            </div>
                            <div class="w-32 h-20 bg-white border border-gray-300 rounded-lg cursor-pointer hover:border-[#5865f2] relative" onclick="setTheme('light')">
                                <span class="text-black text-xs font-bold absolute bottom-2 left-2">Light</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://discord.com/api/v10';
        let ws=null, account=null, channel=null, seq=null, heartbeat=null;
        let attach=null, replyId=null, isLoading=false, oldestId=null;
        let guilds = new Map();
        let folders = [];
        
        // Config
        let config = JSON.parse(localStorage.getItem('config')) || {
            showMeYourName: false,
            sendSeconds: false,
            messageLogger: true,
            showChar: true
        };

        // --- Init ---
        window.onload = () => {
            if(localStorage.theme==='light') document.documentElement.classList.remove('dark');
            else document.documentElement.classList.add('dark');
            
            checkAuth();

            // Bind Events
            document.getElementById('token-input').onkeydown=e=>{if(e.key==='Enter')login()};
            document.getElementById('login-btn').onclick=login;
            document.getElementById('message-input').onkeydown=e=>{
                if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}
                handleInput();
            };
            document.getElementById('message-input').oninput=handleInput;
            document.getElementById('file-input').onchange=e=>{if(e.target.files[0])setFile(e.target.files[0])};
            document.getElementById('send-button').onclick=sendMsg;
            document.getElementById('message-container').onscroll=onScroll;
        };

        // --- Auth ---
        function checkAuth() {
            const accs = JSON.parse(localStorage.getItem('accounts')) || [];
            const active = localStorage.getItem('activeId');
            if(accs.length && active) {
                const ac = accs.find(a=>a.id===active);
                if(ac) { useAccount(ac); return; }
            }
            toggleAuthMode(true);
        }

        function toggleAuthMode(hasSaved) {
            const accs = JSON.parse(localStorage.getItem('accounts')) || [];
            const sec = document.getElementById('auth-section');
            const main = document.getElementById('main-app');
            const sel = document.getElementById('account-selection');
            const form = document.getElementById('token-form');
            const list = document.getElementById('saved-list');

            if(!hasSaved) { // Token input
                sel.classList.add('hidden'); form.classList.remove('hidden');
                document.getElementById('back-btn').classList.toggle('hidden', accs.length===0);
            } else { // List
                if(accs.length===0) return toggleAuthMode(false);
                list.innerHTML = accs.map(a => `<div onclick="useAccountId('${a.id}')" class="flex items-center gap-3 p-3 rounded bg-gray-200 dark:bg-[#1e1f22] cursor-pointer hover:bg-gray-300 dark:hover:bg-[#35373c]"><img class="w-8 h-8 rounded-full" src="${icon(a)}"><span class="font-bold">${a.username}</span></div>`).join('');
                sel.classList.remove('hidden'); form.classList.add('hidden');
            }
            sec.classList.remove('hidden'); main.classList.add('hidden');
        }

        async function login() {
            const t = document.getElementById('token-input').value.trim();
            if(!t) return;
            const res = await fetch(`${API}/users/@me`, {headers:{Authorization:t}});
            if(res.ok) {
                const data = await res.json();
                const acc = {...data, token:t};
                let accs = JSON.parse(localStorage.getItem('accounts')) || [];
                const idx = accs.findIndex(a=>a.id===data.id);
                if(idx!==-1) accs[idx]=acc; else accs.push(acc);
                localStorage.setItem('accounts', JSON.stringify(accs));
                useAccount(acc);
            } else {
                document.getElementById('login-error').innerText = "ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥„Åß„Åô";
            }
        }

        function useAccountId(id) {
            const accs = JSON.parse(localStorage.getItem('accounts'));
            useAccount(accs.find(a=>a.id===id));
        }

        function useAccount(ac) {
            account = ac;
            localStorage.setItem('activeId', ac.id);
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // User Panel Render
            document.getElementById('current-user-name').innerText = ac.username;
            document.getElementById('current-user-tag').innerText = '#' + ac.discriminator;
            const uAva = icon(ac, 128);
            let deco = '';
            if(ac.avatar_decoration_data) {
                // Ensure overflow:hidden parent keeps it contained
                deco = `<img src="https://cdn.discordapp.com/avatar-decoration-presets/${ac.avatar_decoration_data.asset}.png?size=64" class="absolute inset-0 w-full h-full scale-125 z-10 pointer-events-none">`;
            }
            document.getElementById('current-user-avatar').innerHTML = `<img src="${uAva}" class="w-full h-full object-cover rounded-full z-0">${deco}`;
            
            // Populate Switcher
            const all = JSON.parse(localStorage.getItem('accounts'))||[];
            document.getElementById('account-list').innerHTML = all.map(a => `<div onclick="useAccountId('${a.id}');document.getElementById('account-switcher').classList.add('hidden')" class="p-2 flex gap-2 items-center cursor-pointer hover:bg-gray-200 dark:hover:bg-[#35373c] m-1 rounded"><img src="${icon(a)}" class="w-5 h-5 rounded-full"><span class="truncate">${a.username}</span></div>`).join('');

            startGateway();
            fetchGuilds();
        }

        function logout() {
            if(ws) ws.close();
            localStorage.removeItem('activeId');
            toggleAuthMode(true);
        }

        // --- Data ---
        async function req(ep, method='GET', body) {
            const opt = {method, headers:{Authorization:account.token}};
            if(body && !(body instanceof FormData)) {
                opt.headers['Content-Type']='application/json';
                opt.body=JSON.stringify(body);
            } else if(body) opt.body=body;
            try { return await fetch(`${API}${ep}`, opt).then(r=>r.ok?(r.status===204?null:r.json()):null); } catch{return null;}
        }

        async function fetchGuilds() {
            const data = await req('/users/@me/guilds');
            if(data) {
                guilds.clear();
                data.forEach(g => guilds.set(g.id, g));
                // Initially render simple list, update when READY comes with folders
                renderServerList();
            }
        }

        function renderServerList() {
            const rail = document.getElementById('guild-list');
            rail.innerHTML = '';
            
            if(folders.length > 0) {
                // Using WS folder data
                folders.forEach(f => {
                    const ids = f.guild_ids;
                    if(!ids.length) return;
                    if(f.id) { // Is Folder
                        const div = document.createElement('div');
                        div.className = 'folder-closed';
                        const relevant = ids.map(id=>guilds.get(id)).filter(Boolean);
                        
                        const renderThumb = () => {
                            div.innerHTML = '';
                            relevant.slice(0,4).forEach(g => div.innerHTML += `<img class="folder-icon-thumb" src="${icon(g)}">`);
                        };
                        renderThumb();

                        const wrap = document.createElement('div');
                        wrap.className = 'w-full hidden flex-col items-center mt-2';
                        relevant.forEach(g => {
                             const el = mkSrv(g);
                             el.classList.add('in-folder');
                             wrap.appendChild(el);
                        });
                        
                        div.onclick = () => {
                            const hidden = wrap.classList.contains('hidden');
                            if(hidden) {
                                wrap.classList.remove('hidden'); wrap.classList.add('flex');
                                div.style.borderRadius = '16px';
                                div.style.backgroundColor = 'transparent';
                                div.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/></svg>`;
                            } else {
                                wrap.classList.add('hidden'); wrap.classList.remove('flex');
                                div.style.backgroundColor = '';
                                div.style.borderRadius = '';
                                renderThumb();
                            }
                        };
                        const c = document.createElement('div'); c.className='flex flex-col items-center gap-1';
                        c.appendChild(div); c.appendChild(wrap);
                        rail.appendChild(c);
                    } else { // Not in folder (flat list in 'null' folder)
                         ids.forEach(id => { const g = guilds.get(id); if(g) rail.appendChild(mkSrv(g)); });
                    }
                });
            } else {
                // Fallback (Flat)
                guilds.forEach(g => rail.appendChild(mkSrv(g)));
            }
        }

        function mkSrv(g) {
            const el = document.createElement('div');
            el.className = 'server-icon group';
            el.innerHTML = g.icon ? `<img src="https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png?size=128">` : `<div class="font-bold text-sm">${g.name.substring(0,2)}</div>`;
            el.onclick = () => loadChannelList(g, el);
            return el;
        }

        async function loadChannelList(g, el) {
            document.querySelectorAll('.server-icon.active').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('guild-header').innerText = g.name;

            const chs = await req(`/guilds/${g.id}/channels`);
            if(!chs) return;
            const list = document.getElementById('channel-list');
            list.innerHTML = '';

            // Grouping
            const map = {};
            chs.forEach(c => { const p=c.parent_id||'null'; if(!map[p])map[p]=[]; map[p].push(c); });

            // No category
            if(map['null']) map['null'].sort((a,b)=>a.position-b.position).forEach(c=>list.appendChild(mkCh(c)));

            // Categories
            const cats = chs.filter(c=>c.type===4).sort((a,b)=>a.position-b.position);
            cats.forEach(c => {
                const head = document.createElement('div');
                head.className = "flex items-center text-xs font-bold text-gray-500 hover:text-gray-300 cursor-pointer mt-4 mb-1 px-1 uppercase select-none";
                head.innerText = c.name;
                const wrap = document.createElement('div');
                (map[c.id]||[]).sort((a,b)=>a.position-b.position).forEach(x=>wrap.appendChild(mkCh(x)));
                head.onclick=()=>{ wrap.classList.toggle('hidden'); head.style.opacity=wrap.classList.contains('hidden')?'0.5':'1'; };
                list.appendChild(head);
                list.appendChild(wrap);
            });
            showSidebar();
        }
        
        function mkCh(c) {
            if(![0,2,5].includes(c.type)) return document.createElement('span');
            const d = document.createElement('div');
            d.className = `channel-item px-2 py-1.5 mx-2 rounded flex items-center cursor-pointer text-sm truncate ${c.type===2?'opacity-60 cursor-not-allowed':''}`;
            d.innerHTML = `<span class="text-gray-500 text-lg mr-1.5 align-middle">#</span> ${c.name}`;
            if(c.type===2) d.innerHTML = `üîä ${c.name}`;
            d.onclick = () => { if(c.type!==2) openChannel(c, d); };
            return d;
        }

        async function loadDMs() {
            document.querySelectorAll('.server-icon.active').forEach(x=>x.classList.remove('active'));
            document.getElementById('dm-icon').classList.add('active');
            document.getElementById('guild-header').innerText = "Direct Messages";
            const list = document.getElementById('channel-list');
            list.innerHTML = '';
            
            const dms = await req('/users/@me/channels');
            if(dms) {
                dms.sort((a,b)=>(b.last_message_id||0)-(a.last_message_id||0));
                dms.forEach(c => {
                   const u = c.recipients[0];
                   if(!u) return;
                   const d = document.createElement('div');
                   d.className = "channel-item px-2 py-2 mx-2 rounded flex items-center cursor-pointer gap-2";
                   d.innerHTML = `<img src="${icon(u)}" class="w-6 h-6 rounded-full"> <span class="truncate font-semibold">${u.username}</span>`;
                   d.onclick = () => openChannel(c, d);
                   list.appendChild(d);
                });
            }
        }

        async function openChannel(c, el) {
            channel = c;
            oldestId = null; isLoading=false;
            document.querySelectorAll('.channel-item.active').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
            
            const t = c.name || (c.recipients ? c.recipients[0].username : "DM");
            document.getElementById('channel-title').innerText = t;

            // UI
            if(window.innerWidth < 768) {
                document.getElementById('sidebar-view').classList.add('hidden');
                document.getElementById('chat-section').classList.remove('hidden');
                document.getElementById('chat-section').classList.add('flex');
            }

            const con = document.getElementById('message-container');
            con.innerHTML = '';
            
            // Initial load -> Instant jump
            const msgs = await req(`/channels/${c.id}/messages?limit=50`);
            if(msgs) {
                if(msgs.length) oldestId = msgs[msgs.length-1].id;
                renderBatch(msgs.reverse());
                // Immediate jump, no smooth
                con.scrollTop = con.scrollHeight;
            }
        }

        async function onScroll() {
            const con = document.getElementById('message-container');
            if(con.scrollTop === 0 && oldestId && !isLoading) {
                isLoading = true;
                const h = con.scrollHeight;
                const msgs = await req(`/channels/${channel.id}/messages?limit=50&before=${oldestId}`);
                if(msgs && msgs.length) {
                    oldestId = msgs[msgs.length-1].id;
                    renderBatch(msgs.reverse(), true);
                    // Adjust scroll to stay visually in place
                    con.scrollTop = con.scrollHeight - h;
                } else oldestId = null;
                isLoading = false;
            }
        }

        function renderBatch(msgs, prepend=false) {
            const con = document.getElementById('message-container');
            const frag = document.createDocumentFragment();
            let lastId = null, lastTime = 0;
            
            msgs.forEach((m, i) => {
                let grouped = false;
                // Grouping logic (simplified)
                if (i>0 && m.author.id === lastId && !m.referenced_message && (new Date(m.timestamp)-lastTime < 300000)) grouped = true;
                
                frag.appendChild(renderMsg(m, grouped));
                lastId = m.author.id;
                lastTime = new Date(m.timestamp).getTime();
            });
            if(prepend) con.prepend(frag); else con.appendChild(frag);
        }

        function renderMsg(m, grouped) {
            // Deleted handling in content
            let bodyHTML = '';
            let contentHTML = parseMD(m.content);
            if(m.deleted) {
                bodyHTML = `<span class="message-content text-gray-800 dark:text-gray-300 opacity-60 line-through text-sm">${contentHTML||'(content)'}</span><span class="deleted-text">(deleted)</span>`;
            } else {
                bodyHTML = `<span class="message-content text-[#dbdee1] leading-6">${contentHTML}</span> ${m.edited_timestamp?'<span class="text-[10px] text-gray-500 select-none">(edited)</span>':''}`;
            }

            // Mentions
            const isMe = account && m.mentions.find(u=>u.id===account.id);
            const hl = isMe ? 'mention-highlight' : '';

            // Attachments
            let attach = '';
            m.attachments.forEach(a => {
                const delCls = m.deleted ? 'deleted-img' : '';
                if(a.content_type?.startsWith('image')) {
                    attach += `<div class="mt-1"><a href="${a.url}" target="_blank"><img src="${a.url}" class="max-w-[320px] max-h-[300px] rounded object-contain bg-gray-800 ${delCls}"></a></div>`;
                } else {
                    attach += `<div class="mt-1 flex items-center p-3 bg-[#2b2d31] border border-gray-700 rounded w-fit gap-2"><div class="text-blue-500 text-2xl">üìÑ</div><a href="${a.url}" target="_blank" class="text-blue-400 hover:underline">${a.filename}</a></div>`;
                }
            });

            // Dom
            const el = document.createElement('div');
            el.id = `msg-${m.id}`;
            el.className = `message-group px-4 ${grouped ? 'grouped' : ''} ${hl} hover:bg-black/5 dark:hover:bg-white/5`;

            // Toolbar
            const tool = `<div class="message-toolbar absolute right-4 -top-2 rounded z-10 flex shadow-sm p-0.5"><div class="p-1 hover:bg-gray-200 dark:hover:bg-[#404249] rounded cursor-pointer text-gray-400" onclick="replyTo('${m.id}','${m.author.username}')">‚Ü©</div><div class="p-1 hover:bg-gray-200 dark:hover:bg-[#404249] rounded cursor-pointer text-red-400" onclick="delMsg('${m.id}')">üóë</div></div>`;

            if(grouped) {
                const date = new Date(m.timestamp);
                const timeStr = config.sendSeconds ? date.toLocaleTimeString() : date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                el.innerHTML = `${tool}<div class="flex relative"><div class="w-[50px] text-[10px] text-gray-500 text-right mr-3 mt-1.5 opacity-0 group-hover:opacity-100 select-none">${timeStr}</div><div class="flex-1 overflow-hidden min-w-0">${bodyHTML}${attach}</div></div>`;
            } else {
                const mem = m.member || {};
                const u = m.author;
                const nick = mem.nick || u.global_name || u.username;
                const ava = mem.avatar ? `https://cdn.discordapp.com/guilds/${m.guild_id}/users/${u.id}/avatars/${mem.avatar}.png?size=64` : icon(u,64);
                const time = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                
                // Reply
                let rep = '';
                if(m.referenced_message) {
                    const r = m.referenced_message;
                    rep = `<div class="flex items-center ml-12 mb-1 opacity-60 text-xs hover:opacity-100 cursor-pointer relative" onclick="scrollToMsg('${r.id}')"><div class="reply-spine"></div><img src="${icon(r.author||{},16)}" class="w-4 h-4 rounded-full mr-1"> <span class="font-bold mr-1">${r.author?.username||'Unknown'}</span> <span class="truncate text-gray-400">${r.content||'Attachment'}</span></div>`;
                }

                // Decoration (Contained, Standard)
                let deco = '';
                if(u.avatar_decoration_data) deco = `<img src="https://cdn.discordapp.com/avatar-decoration-presets/${u.avatar_decoration_data.asset}.png?size=64" class="absolute inset-0 w-full h-full scale-110 z-10 pointer-events-none">`;

                el.innerHTML = `
                ${tool}${rep}
                <div class="flex mt-0.5 relative">
                    <div class="w-10 h-10 flex-shrink-0 ml-4 mr-4 relative cursor-pointer active:translate-y-[1px]">
                        <img src="${ava}" class="w-full h-full rounded-full relative z-0">${deco}
                    </div>
                    <div class="flex-1 min-w-0 overflow-hidden">
                        <div class="flex items-baseline">
                            <span class="font-medium text-black dark:text-white mr-2 hover:underline cursor-pointer" style="color:${mem.color?'#'+mem.color.toString(16):''}">${nick}</span>
                            <span class="text-xs text-gray-400">${time}</span>
                        </div>
                        <div>${bodyHTML}${attach}</div>
                    </div>
                </div>`;
            }
            return el;
        }

        function parseMD(t) {
            if(!t) return '';
            t = t.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            t = t.replace(/&lt;@!?(\d+)&gt;/g, '<span class="mention">@user</span>'); 
            t = t.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-[#00b0f4] hover:underline">$1</a>');
            t = t.replace(/\n/g, '<br>');
            return t;
        }

        async function sendMsg() {
            const i = document.getElementById('message-input');
            const txt = i.value.trim();
            if(!txt && !attach) return;
            
            // disable button to prevent spam
            document.getElementById('send-button').disabled = true;

            const temp = 'temp-'+Date.now();
            const payload = { content:txt };
            if(replyId) payload.message_reference = { message_id: replyId };

            const fd = new FormData();
            if(attach) { fd.append('payload_json', JSON.stringify(payload)); fd.append('files[0]', attach); }
            else fd.append('payload_json', JSON.stringify(payload)); // trick to re-use FD logic or just json

            const opt = { method:'POST', body:attach?fd:JSON.stringify(payload), headers:{Authorization:account.token} };
            if(!attach) opt.headers['Content-Type']='application/json';

            // Clean UI
            cancelAttachment(); cancelReply();
            i.value = ''; handleInput();
            
            // Optimistic
            const con = document.getElementById('message-container');
            const fake = {
                id:temp, author:account, content:txt, timestamp:new Date().toISOString(), attachments:[], mentions:[]
            };
            con.appendChild(renderMsg(fake, false));
            con.scrollTop = con.scrollHeight;

            const r = await fetch(`${API}/channels/${channel.id}/messages`, opt);
            if(r.ok) {
                // Success: remove temp, wait for WS. Or just keep temp until re-render.
                document.getElementById('msg-'+temp)?.remove(); // removing temp so WS ver takes over
            } else {
                document.getElementById('msg-'+temp)?.classList.add('opacity-50');
            }
            document.getElementById('send-button').disabled = false;
        }

        async function delMsg(id) {
            if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) await req(`/channels/${channel.id}/messages/${id}`, 'DELETE');
        }

        function handleInput() {
            const i = document.getElementById('message-input');
            i.style.height='auto'; i.style.height=i.scrollHeight+'px';
            const b = document.getElementById('send-button');
            const c = i.value.length;
            if(config.showChar) {
                const ct = document.getElementById('char-count');
                ct.classList.remove('hidden'); ct.innerText = `${c}/2000`;
                ct.style.color = c>2000?'red':'inherit';
            }
            b.disabled = (!c && !attach);
        }

        function setFile(f) {
            attach = f;
            document.getElementById('attach-preview').classList.remove('hidden');
            document.getElementById('input-addons').classList.remove('hidden'); document.getElementById('input-addons').classList.add('flex');
            document.getElementById('file-name').innerText = f.name;
            handleInput();
        }
        function cancelAttachment() {
            attach=null; document.getElementById('file-input').value='';
            document.getElementById('attach-preview').classList.add('hidden');
            checkAddon(); handleInput();
        }
        function replyTo(id, name) {
            replyId = id;
            document.getElementById('reply-preview').classList.remove('hidden');
            document.getElementById('reply-target').innerText = name;
            document.getElementById('input-addons').classList.remove('hidden'); document.getElementById('input-addons').classList.add('flex');
            document.getElementById('message-input').focus();
        }
        function cancelReply() {
            replyId = null;
            document.getElementById('reply-preview').classList.add('hidden');
            checkAddon();
        }
        function checkAddon() {
            if(!attach && !replyId) {
                document.getElementById('input-addons').classList.add('hidden'); document.getElementById('input-addons').classList.remove('flex');
            }
        }
        function scrollToMsg(id) {
            const e = document.getElementById('msg-'+id);
            if(e){e.scrollIntoView({block:'center'}); e.classList.add('flash-highlight'); setTimeout(()=>e.classList.remove('flash-highlight'),1000);}
        }

        // --- WebSocket ---
        function startGateway() {
            if(ws) ws.close();
            ws = new WebSocket('wss://gateway.discord.gg/?v=10&encoding=json');
            ws.onmessage = e => {
                const p = JSON.parse(e.data);
                const {t,d,op} = p;
                
                if(t==='READY') {
                    if(d.user_settings?.guild_folders) {
                        folders = d.user_settings.guild_folders;
                        renderServerList(); // Correct order re-render
                    }
                }

                if(t==='MESSAGE_CREATE' && d.channel_id===channel?.id) {
                    const con = document.getElementById('message-container');
                    // Check previous grouping
                    const last = con.lastElementChild;
                    let grp = false;
                    // (Simplified logic)
                    if(last && last.innerHTML.includes(d.author.id)) grp=true; // lazy hack
                    con.appendChild(renderMsg(d, false)); 
                    // Auto scroll if near bottom
                    if(con.scrollHeight - con.scrollTop - con.clientHeight < 200) con.scrollTop = con.scrollHeight;
                }

                if(t==='MESSAGE_DELETE' && d.channel_id===channel?.id) {
                    if(config.messageLogger) {
                        const el = document.getElementById(`msg-${d.id}`);
                        if(el) {
                            // Text
                            const c = el.querySelector('.message-content');
                            if(c && !c.innerText.includes('(deleted)')) c.innerHTML += `<span class="deleted-text">(deleted)</span>`;
                            // Images
                            el.querySelectorAll('img').forEach(i => {
                                if(!i.src.includes('avatar') && !i.src.includes('decoration')) i.classList.add('deleted-img');
                            });
                        }
                    } else {
                        document.getElementById(`msg-${d.id}`)?.remove();
                    }
                }
                
                if(t==='MESSAGE_UPDATE' && d.channel_id===channel?.id) {
                     const el = document.getElementById(`msg-${d.id}`);
                     if(el && d.content) {
                         const c = el.querySelector('.message-content');
                         c.innerHTML = parseMD(d.content) + ` <span class="text-[10px] text-gray-500">(edited)</span>`;
                     }
                }

                if(op===10) {
                    heartbeat = setInterval(()=>ws.send(JSON.stringify({op:1,d:seq})), d.heartbeat_interval);
                    ws.send(JSON.stringify({op:2, d:{token:account.token, properties:{os:"windows",browser:"chrome",device:""}}}));
                }
                if(p.s) seq=p.s;
            };
        }

        // Helpers
        function icon(u, s=64) {
            return u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=${s}` : `https://cdn.discordapp.com/embed/avatars/${u.discriminator%5}.png`;
        }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); renderPluginList(); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function showSidebar() { document.getElementById('sidebar-view').classList.remove('hidden'); document.getElementById('chat-section').classList.add('hidden'); }
        function switchTab(t) {
            document.querySelectorAll('.settings-tab').forEach(e => e.classList.toggle('active', e.innerText.toLowerCase()===t));
            document.getElementById('tab-content-plugins').classList.toggle('hidden', t!=='plugins');
            document.getElementById('tab-content-general').classList.toggle('hidden', t!=='general');
        }
        function setTheme(m) {
            localStorage.setItem('theme', m);
            if(m==='dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
        }
        function renderPluginList() {
            const list = document.getElementById('plugin-list');
            list.innerHTML = '';
            Object.keys(config).forEach(k => {
                const r = document.createElement('div');
                r.className = "flex justify-between items-center py-2 border-b dark:border-gray-700";
                r.innerHTML = `<span>${k}</span><label class="switch"><input type="checkbox" ${config[k]?'checked':''}><span class="slider"></span></label>`;
                r.querySelector('input').onchange = e => {
                    config[k] = e.target.checked;
                    localStorage.setItem('config', JSON.stringify(config));
                };
                list.appendChild(r);
            });
        }
    </script>
</body>
</html>
